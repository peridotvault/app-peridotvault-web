# PeridotVault Studio API Specification

## Authentication API

This document describes the authentication API endpoints required for the PeridotVault Studio application. All authentication is **wallet-based** using the Peridot Wallet extension.

### Base URL
```
https://api.peridotvault.com
```

### Authentication Method
All authenticated requests must include:
```
Authorization: Bearer {token}
X-Wallet-Address: {wallet_address}
```

---

## Endpoints

### 1. Verify Wallet Signature

Verifies a wallet signature and returns an authentication token.

**Endpoint:** `POST /api/auth/verify`

**Request Body:**
```json
{
  "signature": "string",
  "message": "string",
  "publicKey": "string",
  "address": "string"
}
```

**Field Descriptions:**
- `signature` - Cryptographic signature generated by the wallet
- `message` - The message that was signed (currently: "Sign this message to authenticate with PeridotVault Studio")
- `publicKey` - The public key from the user's wallet
- `address` - The wallet address (e.g., "0x1234...")

**Success Response:** `200 OK`
```json
{
  "success": true,
  "message": "Authentication successful",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "address": "0x1234567890abcdef1234567890abcdef12345678",
      "publicKey": "0xabcdef...",
      "username": null,
      "email": null
    }
  },
  "error": null
}
```

**Error Responses:**

`400 Bad Request` - Invalid signature format
```json
{
  "success": false,
  "message": "Invalid signature format",
  "data": null,
  "error": "INVALID_SIGNATURE_FORMAT"
}
```

`401 Unauthorized` - Signature verification failed
```json
{
  "success": false,
  "message": "Signature verification failed",
  "data": null,
  "error": "INVALID_SIGNATURE"
}
```

`429 Too Many Requests` - Rate limit exceeded
```json
{
  "success": false,
  "message": "Too many authentication attempts",
  "data": null,
  "error": "RATE_LIMIT_EXCEEDED"
}
```

**Implementation Notes:**
- The signature should be cryptographically verified against the message and public key
- The returned token should be a JWT with appropriate expiration (recommend 24 hours)
- The token should contain the wallet address in the claims
- Implement rate limiting to prevent brute force attacks

---

### 2. Get User Profile

Retrieves the profile of the currently authenticated user.

**Endpoint:** `GET /api/auth/profile`

**Headers:**
```
Authorization: Bearer {token}
X-Wallet-Address: {wallet_address}
```

**Success Response:** `200 OK`
```json
{
  "success": true,
  "message": "Profile retrieved successfully",
  "data": {
    "address": "0x1234567890abcdef1234567890abcdef12345678",
    "publicKey": "0xabcdef...",
    "username": null,
    "email": null,
    "createdAt": "2025-01-15T10:30:00Z",
    "updatedAt": "2025-01-15T10:30:00Z"
  },
  "error": null
}
```

**Error Responses:**

`401 Unauthorized` - Invalid or expired token
```json
{
  "success": false,
  "message": "Invalid token",
  "data": null,
  "error": "INVALID_TOKEN"
}
```

`401 Unauthorized` - Token expired
```json
{
  "success": false,
  "message": "Token expired",
  "data": null,
  "error": "TOKEN_EXPIRED"
}
```

`404 Not Found` - User not found
```json
{
  "success": false,
  "message": "User not found",
  "data": null,
  "error": "USER_NOT_FOUND"
}
```

**Implementation Notes:**
- The token should be validated and decoded to extract the wallet address
- Return the user profile associated with the wallet address
- If this is the first time the wallet is seen, create a new user profile
- Username and email are optional fields for future use

---

### 3. Logout User

Invalidates the current user session.

**Endpoint:** `POST /api/auth/logout`

**Headers:**
```
Authorization: Bearer {token}
X-Wallet-Address: {wallet_address}
```

**Success Response:** `200 OK`
```json
{
  "success": true,
  "message": "Logout successful",
  "data": null,
  "error": null
}
```

**Error Responses:**

`401 Unauthorized` - Invalid token
```json
{
  "success": false,
  "message": "Invalid token",
  "data": null,
  "error": "INVALID_TOKEN"
}
```

**Implementation Notes:**
- Add the token to a blacklist/revocation list if using token refresh
- Clear any server-side session data
- The client should clear the stored credentials after successful logout
- This endpoint should always succeed even if the token is already invalid

---

## Token Refresh (Optional but Recommended)

To improve security and user experience, implement a token refresh mechanism.

### Refresh Token Endpoint

**Endpoint:** `POST /api/auth/refresh`

**Headers:**
```
Authorization: Bearer {expired_token}
X-Wallet-Address: {wallet_address}
```

**Success Response:** `200 OK`
```json
{
  "success": true,
  "message": "Token refreshed successfully",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresAt": "2025-01-16T10:30:00Z"
  },
  "error": null
}
```

**Error Responses:**

`401 Unauthorized` - Token invalid or expired for too long
```json
{
  "success": false,
  "message": "Token refresh failed",
  "data": null,
  "error": "REFRESH_FAILED"
}
```

**Implementation Notes:**
- Allow refresh within a grace period (e.g., 30 minutes after expiration)
- Return a new token with the same expiration policy
- Implement a maximum refresh window to force re-authentication periodically

---

## Error Codes Reference

| Error Code | Description | HTTP Status |
|------------|-------------|-------------|
| `INVALID_SIGNATURE_FORMAT` | Signature format is invalid | 400 |
| `INVALID_SIGNATURE` | Signature verification failed | 401 |
| `INVALID_TOKEN` | Token is malformed or invalid | 401 |
| `TOKEN_EXPIRED` | Token has expired | 401 |
| `REFRESH_FAILED` | Token refresh failed | 401 |
| `USER_NOT_FOUND` | User profile not found | 404 |
| `RATE_LIMIT_EXCEEDED` | Too many requests | 429 |
| `INTERNAL_ERROR` | Internal server error | 500 |

---

## Security Considerations

### 1. Signature Verification
- Verify the signature cryptographically using the public key
- Ensure the message matches exactly what was signed
- Use a constant-time comparison to prevent timing attacks

### 2. Token Security
- Use JWT with strong signing algorithm (HS256 or RS256)
- Set appropriate token expiration (recommend 24 hours)
- Include wallet address in token claims
- Implement token blacklist for logout

### 3. Rate Limiting
- Implement rate limiting on `/auth/verify` endpoint
- Recommend: 5 attempts per minute per IP address
- Implement exponential backoff for repeated failures

### 4. CORS Configuration
```javascript
// CORS headers for frontend domain
Access-Control-Allow-Origin: https://peridotvault.com
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Authorization, Content-Type, X-Wallet-Address
Access-Control-Allow-Credentials: true
```

### 5. Request Validation
- Validate all request fields (signature, message, publicKey, address)
- Check for proper field types and formats
- Sanitize inputs to prevent injection attacks

---

## Authentication Flow Diagram

```
┌─────────────────┐
│  User clicks    │
│ "Connect Wallet"│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Peridot Wallet  │
│ Extension opens │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│ Wallet signs message:   │
│ "Sign this message to   │
│ authenticate with..."   │
└────────┬────────────────┘
         │
         ▼
┌─────────────────┐
│ Frontend sends  │
│ POST /auth/verify│
│ with signature  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Backend verifies│
│ signature       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Backend returns │
│ JWT token       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Frontend stores │
│ token & updates │
│ auth state      │
└─────────────────┘
```

---

## Postman Collection

### Environment Variables
```json
{
  "base_url": "https://api.peridotvault.com",
  "token": "",
  "wallet_address": "0x1234..."
}
```

### Request: Verify Signature
```bash
curl -X POST {{base_url}}/api/auth/verify \
  -H "Content-Type: application/json" \
  -d '{
    "signature": "0x...",
    "message": "Sign this message to authenticate with PeridotVault Studio",
    "publicKey": "0x...",
    "address": "0x..."
  }'
```

### Request: Get Profile
```bash
curl -X GET {{base_url}}/api/auth/profile \
  -H "Authorization: Bearer {{token}}" \
  -H "X-Wallet-Address: {{wallet_address}}"
```

### Request: Logout
```bash
curl -X POST {{base_url}}/api/auth/logout \
  -H "Authorization: Bearer {{token}}" \
  -H "X-Wallet-Address: {{wallet_address}}"
```

---

## Testing Checklist

### Signature Verification
- [ ] Valid signature returns 200 with token
- [ ] Invalid signature returns 401
- [ ] Malformed signature returns 400
- [ ] Signature replay attack is prevented

### Token Management
- [ ] Token can be decoded to get wallet address
- [ ] Expired token returns 401 with TOKEN_EXPIRED
- [ ] Invalid token returns 401 with INVALID_TOKEN
- [ ] Token contains required claims

### Profile Management
- [ ] Profile can be retrieved with valid token
- [ ] Profile is created on first login
- [ ] Profile returns user data correctly
- [ ] Request without token returns 401

### Logout
- [ ] Logout invalidates the token
- [ ] Token cannot be used after logout
- [ ] Logout succeeds even for invalid tokens

### Rate Limiting
- [ ] Multiple failed attempts are rate limited
- [ ] Rate limit response includes proper headers
- [ ] Rate limit resets after time window

---

## Frontend Integration Notes

### Current Frontend Implementation
The frontend is located at `/src/features/auth/` and includes:

- **Wallet Connection:** Uses Peridot Wallet extension to sign messages
- **Auth Context:** Global state management for authentication
- **HTTP Interceptors:** Automatically inject auth headers
- **Route Protection:** Client-side protection for studio routes

### What Frontend Expects
1. **Response Format:** All responses follow `ApiResponse<T>` interface
2. **Error Format:** Consistent error messages with error codes
3. **Token Format:** JWT that can be decoded on client side
4. **CORS:** Properly configured for the frontend domain

### Current Frontend Status
- ✅ Wallet connection flow is complete
- ✅ Auth state management is implemented
- ✅ HTTP interceptors are ready
- ⏳ Real API integration (awaiting backend)
- ⏳ Token refresh system (to be implemented)

---

## Future Enhancements

### Potential Future Features
1. **Multi-wallet Support:** Allow users to connect multiple wallets
2. **Email Recovery:** Add email as recovery method
3. **2FA:** Optional two-factor authentication
4. **Session Management:** View and manage active sessions
5. **OAuth Integration:** Social login options

### Backward Compatibility
All future enhancements should maintain backward compatibility with the current wallet-only authentication flow.

---

## Support

For questions or issues regarding this API specification, please contact:
- **Frontend Team:** [frontend@example.com]
- **Backend Team:** [backend@example.com]
- **API Documentation:** This document should be kept in sync with implementation

---

**Document Version:** 1.0.0
**Last Updated:** 2025-01-15
**Status:** Ready for Implementation
